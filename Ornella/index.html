<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gratta e Vinci – Ornella Edition</title>
  <style>
    /* --- Base, senza alterare il design: stile minimale e neutro --- */
    :root { color-scheme: light dark; }
    html, body { margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; line-height: 1.5; }
    .wrap { max-width: 860px; margin: 0 auto; padding: 24px; }
    h1 { font-size: 1.8rem; margin: 0 0 8px; }
    h2 { font-size: 1.2rem; margin: 0 0 16px; opacity: .8; }
    p { margin: 0 0 12px; }

    /* --- Sezione Gratta e Vinci --- */
    .scratch-section { margin-top: 24px; }
    .scratch-container { position: relative; width: 100%; max-width: 720px; margin: 16px 0; border-radius: 12px; overflow: hidden; overscroll-behavior: contain; }
    .scratch-content { position: relative; z-index: 0; padding: 24px; text-align: center; background: #fff; color: #222; }
    @media (prefers-color-scheme: dark) {
      .scratch-content { background: #111; color: #eee; }
    }

    /* Canvas di copertura (vernice da grattare) */
    #scratchCanvas { position: absolute; inset: 0; width: 100%; height: 100%; touch-action: none; -webkit-user-select: none; user-select: none; cursor: pointer; }

    .actions { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .btn { appearance: none; border: 0; border-radius: 999px; padding: 10px 16px; font-weight: 600; cursor: pointer; background: #222; color: #fff; }
    .btn.secondary { background: #666; }

    /* Blocca lo scroll del body solo mentre si gratta */
    body.no-scroll { position: fixed; width: 100%; overflow: hidden; }

    /* Feedback percentuale (opzionale) */
    .progress { font-size: .9rem; opacity: .7; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Gratta e Vinci – Ornella Edition (Autoplay + Immagini + Rigratta)</h1>
      <h2>BUONO EMOTIVO</h2>
    </header>

    <section>
      <p><strong>Ciao Arianna</strong></p>
      <p>Sono Ornella. Questo è un buono per riportarmi in vita — con classe e autoironia. Tu, nel dubbio, drammatizza bene.<br>— Ornella (spirito guida)</p>
      <p>Pronta? Gratta con sentimento… e aspettative basse.</p>
      <!-- ⚠️ Rimosso il pulsante "Vai subito al Gratta e Vinci" come richiesto -->
    </section>

    <section class="gallery">
      <p>Ornella – foto 1 “Metti il rossetto e il coraggio.”</p>
      <p>Ornella – foto 2 “La classe non va a dormire.”</p>
      <p>Ornella – foto 3 “Dramma? Solo se sta bene con l’outfit.”</p>
    </section>

    <section class="scratch-section" id="scratch">
      <h2>SUPER ORNELLA</h2>
      <p><em>Biglietto emotivamente impegnativo</em><br>— Ornella, più o meno</p>

      <div class="scratch-container" id="scratchContainer" aria-label="Area gratta e vinci">
        <div class="scratch-content" id="reveal">
          <p style="font-size:1.4rem; margin-bottom:8px;">Gratta. Ma con sentimento.</p>
          <p class="progress" id="progress">Copertura: 100%</p>
        </div>
        <canvas id="scratchCanvas" aria-label="Strato da grattare"></canvas>
      </div>

      <div class="actions">
        <button class="btn" id="resetBtn" type="button" aria-label="Rigratta">Rigratta ✨</button>
        <button class="btn secondary" id="playAudio" type="button" aria-label="Avvia la canzone">▶️ Clicca per far partire la canzone</button>
        <audio id="song" preload="none">
          <!-- Inserisci il tuo file audio: <source src="song.mp3" type="audio/mpeg"> -->
        </audio>
      </div>
    </section>
  </div>

  <script>
    // --- Setup audio play (non cambia il design) ---
    const playBtn = document.getElementById('playAudio');
    const song = document.getElementById('song');
    playBtn?.addEventListener('click', () => {
      song?.play?.().catch(()=>{});
    });

    // --- Gratta e vinci: comportamento mobile stabile ---
    const container = document.getElementById('scratchContainer');
    const canvas = document.getElementById('scratchCanvas');
    const ctx = canvas.getContext('2d');
    const progressEl = document.getElementById('progress');
    const resetBtn = document.getElementById('resetBtn');

    let scratching = false;
    let brush = 24; // raggio pennello

    function resizeCanvas() {
      // Mappa il canvas alla dimensione CSS del container per avere definizione corretta
      const rect = container.getBoundingClientRect();
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      canvas.width = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);
      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';
      // Riapplica la copertura
      cover();
    }

    function cover() {
      // Crea uno strato "vernice" con un leggero effetto metallo/granulato
      const w = canvas.width, h = canvas.height;
      const gradient = ctx.createLinearGradient(0, 0, w, h);
      gradient.addColorStop(0, '#bfbfbf');
      gradient.addColorStop(1, '#9c9c9c');
      ctx.globalCompositeOperation = 'source-over';
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, w, h);
      // Puntinato leggero
      const dots = Math.floor((w*h) / 12000);
      for (let i = 0; i < dots; i++) {
        ctx.fillStyle = 'rgba(255,255,255,0.15)';
        ctx.beginPath();
        ctx.arc(Math.random()*w, Math.random()*h, Math.random()*2+0.5, 0, Math.PI*2);
        ctx.fill();
      }
      updateProgress(100);
    }

    function getXY(e) {
      const rect = canvas.getBoundingClientRect();
      const dpr = canvas.width / rect.width; // rapporto per coordinate precise
      const p = e.touches?.[0] || e;
      const x = (p.clientX - rect.left) * dpr;
      const y = (p.clientY - rect.top)  * dpr;
      return { x, y };
    }

    function scratch(x, y) {
      ctx.globalCompositeOperation = 'destination-out';
      ctx.beginPath();
      ctx.arc(x, y, brush, 0, Math.PI * 2);
      ctx.fill();
    }

    function start(e) {
      scratching = true;
      e.preventDefault();                  // blocca scroll/zoom del browser
      document.body.classList.add('no-scroll');
      const { x, y } = getXY(e);
      scratch(x, y);
    }

    function move(e) {
      if (!scratching) return;
      e.preventDefault();
      const { x, y } = getXY(e);
      scratch(x, y);
    }

    function end(e) {
      if (!scratching) return;
      scratching = false;
      e.preventDefault();
      document.body.classList.remove('no-scroll');
      // aggiorna percentuale approssimativa grattata
      estimateCoverage();
    }

    // Percentuale copertura rimanente (approssimata)
    function estimateCoverage() {
      try {
        const img = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
        let covered = 0;
        // Campiona ogni 16px (per performance)
        const step = 16 * 4; // RGBA stride
        for (let i = 3; i < img.length; i += step) { // usa alpha
          if (img[i] > 10) covered++;
        }
        const total = Math.ceil(img.length / step);
        const percent = Math.round((covered / total) * 100);
        updateProgress(percent);
      } catch (err) {
        // In alcuni browser, getImageData può essere limitato; ignora
      }
    }

    function updateProgress(p) {
      if (progressEl) progressEl.textContent = 'Copertura: ' + p + '%';
    }

    // Eventi con passive:false per poter chiamare preventDefault()
    canvas.addEventListener('pointerdown', start, { passive: false });
    canvas.addEventListener('pointermove', move,   { passive: false });
    window.addEventListener('pointerup',   end,    { passive: false });

    // Salvagente iOS: blocca lo scroll del touchmove quando stai grattando
    window.addEventListener('touchmove', (e) => {
      if (scratching) e.preventDefault();
    }, { passive: false });

    // Reset / Rigratta
    resetBtn?.addEventListener('click', () => cover());

    // Resize iniziale e on resize
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
  </script>
</body>
</html>
